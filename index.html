<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>实时物体识别</title>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.21.0/dist/tf.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/coco-ssd@2.2.3"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body, html { width: 100%; height: 100%; overflow: hidden; background: #000; font-family: Arial, sans-serif; }
        #container { position: relative; width: 100vw; height: 100vh; }
        #video { position: absolute; top: 0; left: 0; width: 100%; height: 100%; object-fit: cover; display: none; } /* 修复：cover 满屏 */
        #canvas { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 2; }
        #stopBtn {
            position: fixed; top: 15px; right: 15px; z-index: 10; padding: 12px 20px; background: #ff3b30; color: #fff;
            border: none; border-radius: 12px; font-size: 15px; font-weight: bold; display: none; cursor: pointer;
            box-shadow: 0 4px 12px rgba(0,0,0,0.4);
        }
        #info {
            position: fixed; bottom: 20px; left: 20px; right: 20px; background: rgba(0,0,0,0.7); color: #fff; padding: 12px;
            border-radius: 12px; text-align: center; font-size: 15px; z-index: 10;
        }
    </style>
</head>
<body>
    <div id="container">
        <video id="video" playsinline muted></video>
        <canvas id="canvas"></canvas>
        <button id="stopBtn">停止检测</button>
        <div id="info">正在启动摄像头...（首次需授权）</div>
    </div>

    <script>
        const video = document.getElementById('video');
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');
        let model, stream, detecting = false;
        let retryCount = 0;
        const maxRetries = 3;

        // 中文标签
        const CN = {
            person: '人', 'cell phone': '手机', cup: '杯子', bottle: '瓶子', laptop: '笔记本',
            book: '书', cat: '猫', dog: '狗', car: '汽车', chair: '椅子', tv: '电视',
            apple: '苹果', banana: '香蕉', orange: '橙子', cake: '蛋糕', knife: '刀'
        };

        // 微信权限修复：检查并提示
        function checkWechatPermission() {
            if (window.__wxjs_environment === 'miniprogram') {
                document.getElementById('info').textContent = '微信环境检测中... 请手动去“设置 > 微信 > 摄像头”开启权限';
                if (typeof WeixinJSBridge !== 'undefined') {
                    WeixinJSBridge.invoke('getNetworkType', {}, function(res) {
                        console.log('微信网络OK，开始摄像头');
                        startDetection();
                    });
                } else {
                    document.addEventListener('WeixinJSBridgeReady', startDetection, false);
                }
            } else {
                startDetection();
            }
        }

        async function startDetection() {
            try {
                if (retryCount >= maxRetries) {
                    throw new Error('重试失败，请检查摄像头权限');
                }
                retryCount++;

                document.getElementById('info').textContent = '请求摄像头权限...';
                stream = await navigator.mediaDevices.getUserMedia({
                    video: { facingMode: 'environment', width: { ideal: 640 }, height: { ideal: 480 } }
                });

                video.srcObject = stream;
                video.play();
                video.style.display = 'block';  // 修复：强制显示视频

                // 等待视频加载
                await new Promise((resolve, reject) => {
                    video.onloadedmetadata = () => {
                        canvas.width = video.videoWidth;
                        canvas.height = video.videoHeight;
                        // 修复：简单全屏适配，无偏移
                        const ratio = Math.min(window.innerWidth / video.videoWidth, window.innerHeight / video.videoHeight);
                        canvas.style.width = (video.videoWidth * ratio) + 'px';
                        canvas.style.height = (video.videoHeight * ratio) + 'px';
                        canvas.style.left = ((window.innerWidth - video.videoWidth * ratio) / 2) + 'px';
                        canvas.style.top = ((window.innerHeight - video.videoHeight * ratio) / 2) + 'px';
                        resolve();
                    };
                    setTimeout(() => reject(new Error('视频加载超时')), 5000);  // 5秒超时
                });

                document.getElementById('info').textContent = '加载AI模型（10-20秒）...';
                model = await cocoSsd.load({ base: 'mobilenet_v2' });

                document.getElementById('info').textContent = '实时识别启动！对准物体试试';
                document.getElementById('stopBtn').style.display = 'block';
                detecting = true;
                loop();
            } catch (err) {
                console.error('启动失败:', err);
                document.getElementById('info').textContent = `错误: ${err.message}。重试中...（${retryCount}/${maxRetries}）`;
                setTimeout(startDetection, 2000);
            }
        }

        function stopDetection() {
            detecting = false;
            if (stream) stream.getTracks().forEach(t => t.stop());
            video.srcObject = null;
            video.style.display = 'none';
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            document.getElementById('stopBtn').style.display = 'none';
            document.getElementById('info').textContent = '已停止。刷新页面重新开始';
        }

        async function loop() {
            if (!detecting || !model || video.videoWidth === 0) {
                requestAnimationFrame(loop);
                return;
            }

            // 重绘视频
            ctx.drawImage(video, 0, 0, canvas.width, canvas.height);

            try {
                const preds = await model.detect(video);
                if (preds.length > 0) {
                    // 只取最高置信度一个
                    const best = preds.reduce((prev, curr) => prev.score > curr.score ? prev : curr);
                    const [x, y, w, h] = best.bbox;

                    // 修复坐标：直接绘制（canvas 已适配视频）
                    ctx.lineWidth = 4;
                    ctx.strokeStyle = '#00ff00';
                    ctx.strokeRect(x, y, w, h);

                    const label = CN[best.class] || best.class;
                    const text = `${label} ${(best.score * 100).toFixed(0)}%`;
                    ctx.font = 'bold 20px Arial';
                    const metrics = ctx.measureText(text);
                    ctx.fillStyle = 'rgba(0, 255, 0, 0.9)';
                    ctx.fillRect(x, y - 32, metrics.width + 16, 32);
                    ctx.fillStyle = '#000';
                    ctx.fillText(text, x + 8, y - 8);
                }
                document.getElementById('info').textContent = `实时识别中... 发现 ${preds.length} 个物体（显示最准一个）`;
            } catch (e) {
                console.error('检测帧失败:', e);
                // 继续循环，不中断
            }

            requestAnimationFrame(loop);
        }

        // 事件
        document.getElementById('stopBtn').onclick = stopDetection;

        // 自动启动
        window.addEventListener('load', checkWechatPermission);

        // 屏幕适配
        window.addEventListener('resize', () => {
            if (video.videoWidth > 0) {
                const ratio = Math.min(window.innerWidth / video.videoWidth, window.innerHeight / video.videoHeight);
                canvas.style.width = (video.videoWidth * ratio) + 'px';
                canvas.style.height = (video.videoHeight * ratio) + 'px';
                canvas.style.left = ((window.innerWidth - video.videoWidth * ratio) / 2) + 'px';
                canvas.style.top = ((window.innerHeight - video.videoHeight * ratio) / 2) + 'px';
            }
        });
    </script>
</body>
</html>
