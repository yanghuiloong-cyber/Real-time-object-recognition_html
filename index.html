<!DOCTYPE html>
<html lang="zh">
<head>
<meta charset="UTF-8">
<title>实时物体检测（微信终极稳定版）</title>
<script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.21.0/dist/tf.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/coco-ssd@2.2.3"></script>
<style>
    body,html{margin:0;padding:0;height:100%;background:#000;overflow:hidden;font-family:Arial,sans-serif;}
    #container{position:relative;width:100vw;height:100vh;}
    video,canvas{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);max-width:100vw;max-height:100vh;}
    canvas{z-index:2;}
    button{position:absolute;z-index:3;padding:12px 20px;border:none;border-radius:8px;background:#07c160;color:#fff;font-size:15px;top:15px;cursor:pointer;}
    #startBtn{left:15px;}
    #switchBtn{left:140px;background:#576b95;display:none;}
    #stopBtn{right:15px;background:#ee0a24;display:none;}
    #info{position:absolute;bottom:15px;left:15px;right:15px;background:rgba(0,0,0,0.7);color:#fff;padding:10px;border-radius:8px;text-align:center;z-index:3;font-size:14px;}
</style>
</head>
<body>
<div id="container">
    <video id="video" playsinline muted></video>
    <canvas id="canvas"></canvas>
    <button id="startBtn">开始检测（后置）</button>
    <button id="switchBtn">切换前置</button>
    <button id="stopBtn">停止检测</button>
    <div id="info">加载中...</div>
</div>

<script>
const video = document.getElementById('video');
const canvas = document.getElementById('canvas');
const ctx = canvas.getContext('2d');
let model, stream, detecting = false, facing = 'environment';

// 中文标签（常用）
const CN = {person:'人',cell phone:'手机',cup:'杯子',bottle:'瓶子',book:'书',cat:'猫',dog:'狗',car:'汽车',chair:'椅子',tv:'电视'};

async function start() {
    stream = await navigator.mediaDevices.getUserMedia({
        video: { facingMode: facing, width: {ideal:512}, height: {ideal:384} }
    });
    video.srcObject = stream;
    await video.play();

    // 关键：固定 canvas 为 512x384（和模型输入一致）
    canvas.width = 512;
    canvas.height = 384;

    // 让 canvas 自适应屏幕（等比缩放，不超过屏幕）
    const ratio = Math.min(window.innerWidth/512, window.innerHeight/384 * 1.1);
    canvas.style.width = (512 * ratio) + 'px';
    canvas.style.height = (384 * ratio) + 'px';

    document.getElementById('startBtn').style.display='none';
    document.getElementById('switchBtn').style.display='block';
    document.getElementById('stopBtn').style.display='block';

    model = await cocoSsd.load({base:'mobilenet_v2'});
    document.getElementById('info').textContent = '模型加载完成，实时检测中...';
    detecting = true;
    loop();
}

function stop() {
    detecting = false;
    if(stream) stream.getTracks().forEach(t=>t.stop());
    video.srcObject = null;
    ctx.clearRect(0,0,canvas.width,canvas.height);
    document.getElementById('startBtn').style.display='block';
    document.getElementById('switchBtn').style.display='none';
    document.getElementById('stopBtn').style.display='none';
    document.getElementById('info').textContent = '已停止';
}

async function loop() {
    if(!detecting) return;

    // 画视频（512x384）
    ctx.drawImage(video, 0, 0, 512, 384);

    const preds = await model.detect(video);  // 直接用 video，坐标天然对齐

    preds.forEach(p=>{
        let [x,y,w,h] = p.bbox;

        // 关键：把模型的 512x384 坐标，映射到 canvas 的显示大小
        const scaleX = canvas.clientWidth / 512;
        const scaleY = canvas.clientHeight / 384;

        x *= scaleX; y *= scaleY; w *= scaleX; h *= scaleY;

        ctx.lineWidth = 3;
        ctx.strokeStyle = '#00ff00';
        ctx.strokeRect(x, y, w, h);

        const label = CN[p.class] || p.class;
        const text = `${label} ${Math.round(p.score*100)}%`;
        ctx.font = 'bold 18px Arial';
        ctx.fillStyle = '#000';
        ctx.fillRect(x, y-28, ctx.measureText(text).width+12, 28);
        ctx.fillStyle = '#00ff00';
        ctx.fillText(text, x+6, y-6);
    });

    document.getElementById('info').textContent = `检测到 ${preds.length} 个物体 | 实时流畅`;

    requestAnimationFrame(loop);
}

// 按钮
document.getElementById('startBtn').onclick = start;
document.getElementById('stopBtn').onclick = stop;
document.getElementById('switchBtn').onclick = ()=>{
    facing = facing==='environment'?'user':'environment';
    stop(); start();
};

// 屏幕旋转适配
window.addEventListener('resize', ()=>{
    if(video.videoWidth){
        const ratio = Math.min(window.innerWidth/512, window.innerHeight/384 * 1.1);
        canvas.style.width = (512 * ratio) + 'px';
        canvas.style.height = (384 * ratio) + 'px';
    }
});
</script>
</body>
</html>
