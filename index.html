<!DOCTYPE html>
<html lang="zh">
<head>
<meta charset="UTF-8">
<title>实时物体检测</title>
<script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.21.0/dist/tf.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/coco-ssd@2.2.3"></script>
<style>
  body,html{margin:0;padding:0;height:100%;background:#000;overflow:hidden;font-family:Arial,sans-serif;}
  #container{position:relative;width:100vw;height:100vh;}
  video,canvas{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);max-width:100vw;max-height:100vh;}
  canvas{z-index:2;}
  #info{position:absolute;bottom:10px;left:0;right:0;color:#fff;background:rgba(0,0,0,0.5);padding:8px;z-index:3;}
  button{position:absolute;z-index:3;padding:10px 16px;border:none;border-radius:6px;background:#fff;color:#000;font-size:14px;}
  #startBtn{top:10px;left:10px;}
  #switchBtn{top:10px;left:100px;}
  #stopBtn{top:10px;right:10px;}
</style>
</head>
<body>
<div id="container">
  <video id="video" playsinline muted></video>
  <canvas id="canvas"></canvas>
  <button id="startBtn">开始检测（后置）</button>
  <button id="switchBtn" style="display:none">切换前置</button>
  <button id="stopBtn" style="display:none">停止</button>
  <div id="info">加载中...</div>
</div>

<script>
const video = document.getElementById('video');
const canvas = document.getElementById('canvas');
const ctx = canvas.getContext('2d');
let model, stream, detecting = false, facing = 'environment';

async function start() {
  stream = await navigator.mediaDevices.getUserMedia({
    video: { facingMode: facing, width: {ideal:640}, height: {ideal:480} }
  });
  video.srcObject = stream;
  await video.play();
  canvas.width = video.videoWidth;
  canvas.height = video.videoHeight;
  document.getElementById('startBtn').style.display='none';
  document.getElementById('switchBtn').style.display='block';
  document.getElementById('stopBtn').style.display='block';

  model = await cocoSsd.load({base: 'mobilenet_v2'});
  document.getElementById('info').textContent = '高精度模型已就绪，开始检测...';
  detecting = true;
  detect();
}

function stop() {
  detecting = false;
  if (stream) stream.getTracks().forEach(t=>t.stop());
  video.srcObject = null;
  ctx.clearRect(0,0,canvas.width,canvas.height);
  document.getElementById('startBtn').style.display='block';
  document.getElementById('switchBtn').style.display='none';
  document.getElementById('stopBtn').style.display='none';
  document.getElementById('info').textContent = '已停止';
}

document.getElementById('startBtn').onclick = ()=>start();
document.getElementById('stopBtn').onclick = ()=>stop();
document.getElementById('switchBtn').onclick = ()=>{
  facing = facing==='environment'?'user':'environment';
  stop(); start();
};

async function detect() {
  if (!detecting) return;
  ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
  const preds = await model.detect(video);
  preds.forEach(p=>{
    const [x,y,w,h] = p.bbox;
    ctx.strokeStyle = 'lime';
    ctx.lineWidth = 3;
    ctx.strokeRect(x,y,w,h);
    ctx.fillStyle = 'lime';
    ctx.font = '16px Arial';
    ctx.fillText(`${p.class} ${Math.round(p.score*100)}%`, x, y>20?y-5:y+20);
  });
  document.getElementById('info').textContent = `检测到 ${preds.length} 个物体 | FPS ${(1000/(performance.now()-last)||0).toFixed(1)}`;
  let last = performance.now();
  requestAnimationFrame(detect);
}
</script>
</body>
</html>